"use strict";const e=require("child_process").execSync;function t(e=""){let t="";return t=e?new Date(e):new Date,`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日${t.getHours()}时${t.getMinutes()}分`}function o(o,n="process"){if("process"===n)return o??"--";if("date"===n){let n="";try{n=t(e(o)?.toString().trim()),e(o)?.toString().trim()}catch(e){n="--"}return n}{let t="";try{t=e(o)?.toString().trim()}catch(e){t="--"}return t}}module.exports=class{constructor(e={}){this.options={name:e?.name??"buildInfo",immediate:e?.immediate??!1,preset:e?.preset??!0,consoleList:e?.consoleList??[]}}consoleList(){let e=[{description:"提交时间",value:o("git show -s --format=%cd","date"),mode:"development"},{description:"构建时间",value:t(),mode:"production"},{description:"提交人员",value:o("git show -s --format=%cn","git"),mode:"development"},{description:"构建人员",value:o(process.env?.TRIGGER_USER_NAME),mode:"production"},{description:"提交邮箱",value:o("git show -s --format=%ce","git"),mode:"development"},{description:"仓库名称",value:o(process.env?.DEPOT_NAME),mode:"production"},{description:"代码分支",value:o("git symbolic-ref --short -q HEAD","git"),mode:"development"},{description:"代码分支",value:o(process.env?.GIT_BRANCH),mode:"production"},{description:"代码版本",value:o("git show -s --format=%h","git"),mode:"development"},{description:"代码版本",value:o(process.env?.GIT_COMMIT_SHORT),mode:"production"},{description:"提交说明",value:o("git show -s --format=%s","git"),mode:"development"},{description:"镜像版本",value:o(process.env?.CODING_DOCKER_IMAGE_NAME),mode:"production"}],n=this.options.consoleList;n=Array.isArray(n)&&n?.filter((e=>e.description))?.map((e=>({description:e.description,value:e?.value||"--",mode:e?.mode||"production"})))||[];let i=[];i=this.options.preset?[...e,...n]:0===n.length?[{description:"异常提示",value:"无可输出的信息！请检查配置或将preset设置为true",mode:"development"},{description:"异常提示",value:"无可输出的信息！请检查配置或将preset设置为true",mode:"production"}]:n;const s=i?.filter((e=>e.mode===process.env.NODE_ENV))?.map((e=>({description:this.encode(e.description),value:this.encode(e.value)})))||[];return JSON.stringify(s)}encode(e=""){if(!e)return"";let t="";for(let o=0;o<e.length;o++)t+=e.charCodeAt(o)+",";return t}getConsoleStr(){return"`%c${decode(description)}%c${decode(value)}`"}developmentTip(){if("development"===process.env.NODE_ENV&&this.options.preset){return`const description = '${this.encode("提示信息")}';\n`+`const value = '${this.encode("当前打印信息基于本地git提交历史，非coding构建信息！")}';\n`+'console.log(`%c${decode(description)}%c${decode(value)}`,"background:#c00 ; padding: 2px 0 2px 5px; border-radius: 3px 0 0 3px;  color: #fff","background:#f56c6c; padding: 2px 0 2px 5px; border-radius: 0 3px 3px 0;  color: #fff")'}return""}jsContent(){return`(function(window){\n  function decode(str = ""){\n    if(!str) return ""\n    let arr = str.split(",");\n    let r = "";\n    for (let i = 0; i < arr.length; i++){\n      r += String.fromCharCode(parseInt(arr[i]));\n    }\n    return r;\n  }\n  function log (description, value) {\n    console.log(\n      ${this.getConsoleStr()},\n      "background:#35495e; padding: 2px 0 2px 5px; border-radius: 3px 0 0 3px;  color: #fff",\n      "background:#41b883; padding: 2px 0 2px 5px; border-radius: 0 3px 3px 0;  color: #fff",\n    )\n  }\n  window.BuildInfoConsoleList = ${this.consoleList()} || []\n  if(${this.options.immediate}){\n    ${this.developmentTip()}\n    BuildInfoConsoleList.forEach(res=>{\n      log (res.description, res.value) \n    })\n  }\n  Object.defineProperty(window, '${this.options.name}', {\n    get: function() {\n      if(BuildInfoConsoleList.length === 0){\n        return console.log("暂无相关信息！")\n      }\n      console.clear();\n      ${this.developmentTip()}\n      BuildInfoConsoleList.forEach(res=>{\n        log (res.description, res.value) \n      })\n    }\n  })\n})(window)`}apply(e){e.hooks.emit.tap("buildInfoPlugin",(t=>{const o=Object.keys(t.assets).find((e=>e.includes(".js"))),n=Object.keys(t.assets).find((e=>e.includes(".html")));if(!o||!n)return;const i=o?.split("/")??[];if(0===i.length)return;i[i.length-1]=`build-info-${(new Date).getTime().toString().slice(7)}.js`;const s=i.join("/");let r=t.assets?.[n]?.source();if(!r)return;let d=r.match(/(?<=<body>)[\s\S]*(?=<\/body>)/gim)?.[0];if(!d)return;d+=`<script src="${e.options.output.publicPath}${s}"><\/script>`;const c=r.replace(/(?<=<body>)[\s\S]*(?=<\/body>)/gim,d);t.assets[n]={source:()=>c,size:()=>c.length};let p=this.jsContent();t.assets[s]={source:()=>p,size:()=>p.length}}))}};
